#!/usr/bin/env bash
# This script configures Nginx to run as the nginx user and listen on port 8080

# Stop nginx service if it's running
service nginx stop

# Ensure nginx user exists
if ! id "nginx" &>/dev/null; then
    adduser --system --no-create-home --shell /usr/sbin/nologin --group nginx
fi

# Update nginx configuration
sed -i "s/#user www-data/user nginx/" /etc/nginx/nginx.conf
sed -i "s/80/8080/g" /etc/nginx/sites-available/default

# Set correct permissions
chown -R nginx:nginx /var/lib/nginx

# Adjust nginx.conf to ensure nginx can read it
chmod 644 /etc/nginx/nginx.conf

# Start nginx service
sudo -u nginx service nginx start

# Verify nginx is running and listening on port 8080
ps aux | grep '[n]ginx:'
netstat -tuln | grep :8080
