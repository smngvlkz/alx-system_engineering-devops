#!/usr/bin/env bash
# Fixes a web server to run Nginx as the nginx user listening on port 8080

# Ensure nginx user exists
if ! id "nginx" &>/dev/null; then
    adduser --system --no-create-home --shell /usr/sbin/nologin --group nginx
fi

# Set permissions and ownership
chmod 644 /etc/nginx/nginx.conf
chown -R nginx:nginx /var/lib/nginx

# Modify nginx.conf to run as nginx user
sed -i "s/#user www-data/user nginx/" /etc/nginx/nginx.conf

# Modify default site to listen on port 8080
sed -i "s/80/8080/g" /etc/nginx/sites-available/default

# Stop apache2 if it's running
pkill apache2

# Start Nginx
service nginx start

# Check if nginx is running
ps aux | grep '[n]ginx'

# Check if nginx is listening on port 8080
nc -z 0 8080 ; echo $?
